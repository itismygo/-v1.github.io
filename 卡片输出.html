<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Result</title>
    <link rel="stylesheet" href="å¡ç‰‡è¾“å‡º.css">

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css" integrity="sha512-fHwaWebuwA7NSF5Qg/af4UeDx9XqUpYpOGgubo3yWu+b2IQR4UeQwbb42Ti7gVAjNtVoI/I9TEoYeu9omwcC6g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js" integrity="sha512-LQNxIMR5rXv7o+b1l8+N1EZMfhG7iFZ9HhnbJkTp4zjNr5Wvst75AqUeFDxeRUa7l5vEDyUiAip//r+EFLLCyA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js" integrity="sha512-iWiuBS5nt6r60fCz26Nd0Zqe0nbk1ZTIQbl3Kv7kYsX+yKMUFHzjaH2+AnM6vp2Xs+gNmaBAVWJjSmuPw76Efg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>

<body>
    <div class="top-bar">
        <button class="back-button">
            <i class="back-arrow"></i>
        </button>
    </div>

    <div class="results-container">
        <div id="geminiResults">
            <p>æ­£åœ¨åŠ è½½æœç´¢ç»“æœ...</p>
        </div>

        <button class="dark-mode-toggle" aria-label="åˆ‡æ¢æ·±è‰²/æµ…è‰²æ¨¡å¼">ğŸŒ™</button>
    </div>

    <script>
        // å‡½æ•°å®šä¹‰ï¼šå°† Markdown æ•°æ®è§£æä¸ºå¸¦å±…ä¸­åŠ ç²—æ ‡é¢˜çš„å¡ç‰‡å¹¶æ˜¾ç¤º
        function displayMarkdownAsCardsWithCenteredAndBoldTitles(data, separator) {
            const resultsDiv = document.getElementById('geminiResults');
            resultsDiv.innerHTML = ''; // æ¸…ç©ºæ—§å†…å®¹
            let cardIndex = 0;

            if (data?.candidates?.[0]?.content?.parts) {
                data.candidates[0].content.parts.forEach(part => {
                    if (part.text) {
                        const sections = part.text.split(new RegExp(`^${separator}\\s*$`, 'm'));

                        sections.forEach(section => {
                            if (section.trim() !== '') {
                                const cardDiv = document.createElement('div');
                                cardDiv.classList.add('markdown-card');

                                const lines = section.trim().split('\n');
                                let centeredBoldTitleHTML = '';
                                let contentWithoutTitle = section.trim();

                                // å¤„ç†æ ‡é¢˜ï¼šå¦‚æœç¬¬ä¸€è¡Œä»¥ # å¼€å¤´ï¼Œåˆ™æå–ä¸ºå±…ä¸­åŠ ç²—æ ‡é¢˜
                                if (lines.length > 0 && lines[0].startsWith('#')) {
                                    let titleHtml = marked.parse(lines[0]).trim();
                                    if (titleHtml.startsWith('<p>') && titleHtml.endsWith('</p>')) {
                                        titleHtml = titleHtml.slice(3, -4);
                                    }
                                    centeredBoldTitleHTML = `<div style="text-align: center; margin-bottom: 10px;"><strong>${titleHtml}</strong></div>`;
                                    contentWithoutTitle = lines.slice(1).join('\n').trim();
                                } else if (lines.length > 0) {
                                    // å¦‚æœç¬¬ä¸€è¡Œä¸æ˜¯æ ‡å‡†æ ‡é¢˜ï¼Œä½†ä½œä¸ºå±…ä¸­åŠ ç²—æ ‡é¢˜æ˜¾ç¤º
                                    let firstLineHtml = marked.parse(lines[0]).trim();
                                    if (firstLineHtml.startsWith('<p>') && firstLineHtml.endsWith('</p>')) {
                                        firstLineHtml = firstLineHtml.slice(3, -4);
                                    }
                                    centeredBoldTitleHTML = `<div style="text-align: center; margin-bottom: 10px;"><strong>${firstLineHtml}</strong></div>`;
                                    contentWithoutTitle = lines.slice(1).join('\n').trim();
                                }

                                const htmlContent = centeredBoldTitleHTML + marked.parse(contentWithoutTitle);
                                cardDiv.innerHTML = htmlContent;

                                // è®¾ç½®åŠ¨ç”»å»¶è¿Ÿ
                                cardDiv.style.setProperty('--animation-order', cardIndex);
                                cardIndex++;

                                resultsDiv.appendChild(cardDiv);
                            }
                        });
                    }
                });

                // æ¸²æŸ“ KaTeX æ•°å­¦å…¬å¼
                renderMathInElement(resultsDiv, {
                    delimiters: [
                        { left: '$', right: '$', display: false },
                        { left: '\\(', right: '\\)', display: false },
                        { left: '\\[', right: '\\]', display: true },
                        { left: '$$', right: '$$', display: true }
                    ],
                    throwOnError: false
                });

            } else {
                resultsDiv.innerHTML = '<p>æœªæ‰¾åˆ°åˆé€‚çš„å›å¤ã€‚</p>';
            }
        }

        // DOMContentLoaded äº‹ä»¶ç›‘å¬å™¨ for å¡ç‰‡è¾“å‡º.html
        document.addEventListener('DOMContentLoaded', () => {
            const resultsDiv = document.getElementById('geminiResults');
            const backButton = document.querySelector('.back-button');
            const toggleButton = document.querySelector('.dark-mode-toggle'); // è·å–æ·±æµ…è‰²åˆ‡æ¢æŒ‰é’®
            const body = document.body; // è·å– body å…ƒç´ 

            // è¿”å›æŒ‰é’®é€»è¾‘
            if (backButton) {
                backButton.addEventListener('click', () => {
                    window.history.back();
                });
            }

            // === æ·±æµ…è‰²æ¨¡å¼å¤„ç†é€»è¾‘ ===
            // æ£€æŸ¥æœ¬åœ°å­˜å‚¨ä¸­æ˜¯å¦æœ‰æ·±è‰²æ¨¡å¼çš„åå¥½
            const isDarkModePreferred = localStorage.getItem('darkMode') === 'enabled';

            // æ ¹æ®åå¥½è®¾ç½®åˆå§‹åŒ–æ·±è‰²æ¨¡å¼
            if (isDarkModePreferred) {
                body.classList.add('dark-mode');
                if (toggleButton) { // ç¡®ä¿æŒ‰é’®å­˜åœ¨å†è®¾ç½®æ–‡æœ¬
                    toggleButton.textContent = 'â˜€ï¸';
                    toggleButton.setAttribute('aria-label', 'åˆ‡æ¢æµ…è‰²æ¨¡å¼');
                }
            } else {
                 if (toggleButton) { // ç¡®ä¿æŒ‰é’®å­˜åœ¨å†è®¾ç½®æ–‡æœ¬
                    toggleButton.textContent = 'ğŸŒ™';
                    toggleButton.setAttribute('aria-label', 'åˆ‡æ¢æ·±è‰²æ¨¡å¼');
                }
            }

            // åˆ‡æ¢æ·±è‰²/æµ…è‰²æ¨¡å¼äº‹ä»¶ç›‘å¬å™¨
            if (toggleButton) {
                toggleButton.addEventListener('click', () => {
                    console.log('æ·±æµ…è‰²åˆ‡æ¢æŒ‰é’®è¢«ç‚¹å‡»äº†ï¼ (å¡ç‰‡è¾“å‡ºé¡µ)');
                    body.classList.toggle('dark-mode');
                    const isDarkModeActive = body.classList.contains('dark-mode');
                    localStorage.setItem('darkMode', isDarkModeActive ? 'enabled' : 'disabled');
                    toggleButton.textContent = isDarkModeActive ? 'â˜€ï¸' : 'ğŸŒ™';
                    toggleButton.setAttribute('aria-label', isDarkModeActive ? 'åˆ‡æ¢æµ…è‰²æ¨¡å¼' : 'åˆ‡æ¢æ·±è‰²æ¨¡å¼');
                });
            }
            // === æ·±æµ…è‰²æ¨¡å¼å¤„ç†é€»è¾‘ç»“æŸ ===


            // åŠ è½½å¹¶æ˜¾ç¤º localStorage ä¸­çš„æœç´¢ç»“æœ
            const geminiResponse = localStorage.getItem('geminiResponse');
            if (geminiResponse) {
                try {
                    const data = JSON.parse(geminiResponse);
                    displayMarkdownAsCardsWithCenteredAndBoldTitles(data, '## -- å¡ç‰‡åˆ†éš” -- ##');
                    localStorage.removeItem('geminiResponse'); // æ˜¾ç¤ºåç§»é™¤æ•°æ®
                } catch (error) {
                    console.error('è§£æå­˜å‚¨çš„å“åº”å¤±è´¥:', error);
                    resultsDiv.innerHTML = '<p class="error">æ— æ³•æ˜¾ç¤ºæœç´¢ç»“æœã€‚</p>';
                }
            } else {
                resultsDiv.innerHTML = '<p>æ²¡æœ‰æ‰¾åˆ°æœç´¢ç»“æœã€‚</p>';
            }

        });
    </script>
</body>

</html>